import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Button, message, Tooltip, Avatar, Typography, Modal, Select } from 'antd';
import { 
  CheckCircleOutlined, 
  CloseCircleOutlined, 
  QuestionCircleOutlined,
  ReloadOutlined,
  FullscreenOutlined,
  SettingOutlined,
  PlayCircleOutlined,
  StopOutlined
} from '@ant-design/icons';
import { useSocket } from '../../contexts/SocketContext';
import { SeatMapData, SeatMap as SeatMapType, SeatStatus } from '../../types';
import { request } from '../../services/api';
import attendanceService, { CheckInMethod, CheckInSession } from '../../services/attendanceService';


interface SeatMapProps {
  classroomId: string;
  courseId: string;
  sessionDate: string;
  timeSlot?: string;
  readonly?: boolean;
  onSeatSelect?: (seatId: string, studentId?: string) => void;
}

interface SeatComponentProps {
  seat: SeatMapType;
  onClick?: () => void;
  readonly?: boolean;
}

// üöÄ CYBER PUNK Â∫ß‰ΩçÊ†∑Âºè
const cyberStyles = {
  container: {
    fontFamily: "'Rajdhani', 'Microsoft YaHei', sans-serif",
    background: 'linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #0f0f23 100%)',
    minHeight: '100vh',
    padding: '24px',
    position: 'relative' as const,
    overflow: 'hidden' as const,
    color: '#ffffff',
  },
  dashboard: {
    background: 'linear-gradient(145deg, rgba(0,255,65,0.1) 0%, rgba(0,128,255,0.1) 50%, rgba(255,0,128,0.1) 100%)',
    border: '2px solid rgba(0,255,65,0.3)',
    borderRadius: '20px',
    padding: '24px',
    marginBottom: '24px',
    boxShadow: '0 20px 40px rgba(0,255,65,0.2), inset 0 1px 0 rgba(255,255,255,0.1)',
    position: 'relative' as const,
  },
  dashboardHeader: {
    textAlign: 'center' as const,
    marginBottom: '20px',
  },
  dashboardTitle: {
    fontSize: '28px',
    fontWeight: '900' as const,
    color: '#00ff41',
    textShadow: '0 0 20px rgba(0,255,65,0.8)',
    marginBottom: '8px',
  },
  dashboardSubtitle: {
    fontSize: '16px',
    color: '#0080ff',
    textShadow: '0 0 10px rgba(0,128,255,0.6)',
  },
  statsGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(4, 1fr)',
    gap: '16px',
    marginTop: '20px',
  },
  statCard: {
    background: 'linear-gradient(145deg, rgba(0,0,0,0.6), rgba(30,30,30,0.8))',
    border: '1px solid rgba(0,255,65,0.4)',
    borderRadius: '12px',
    padding: '16px',
    textAlign: 'center' as const,
    position: 'relative' as const,
    transition: 'all 0.3s ease',
  },
  statNumber: {
    fontSize: '24px',
    fontWeight: 'bold' as const,
    color: '#00ff41',
    textShadow: '0 0 10px rgba(0,255,65,0.6)',
  },
  statLabel: {
    fontSize: '12px',
    color: '#ffffff',
    opacity: 0.8,
    marginTop: '4px',
  },
  controlPanel: {
    display: 'flex',
    gap: '12px',
    marginBottom: '24px',
    justifyContent: 'center',
  },
  cyberButton: {
    background: 'linear-gradient(145deg, rgba(0,255,65,0.2), rgba(0,128,255,0.2))',
    border: '2px solid rgba(0,255,65,0.5)',
    borderRadius: '8px',
    color: '#00ff41',
    fontWeight: 'bold' as const,
    textShadow: '0 0 10px rgba(0,255,65,0.6)',
    boxShadow: '0 4px 15px rgba(0,255,65,0.3)',
    transition: 'all 0.3s ease',
  },
  podium: {
    background: 'linear-gradient(145deg, rgba(255,215,0,0.2), rgba(255,140,0,0.3))',
    border: '2px solid rgba(255,215,0,0.6)',
    borderRadius: '15px',
    padding: '16px',
    textAlign: 'center' as const,
    marginBottom: '20px',
    color: '#ffd700',
    fontSize: '16px',
    fontWeight: 'bold' as const,
    textShadow: '0 0 15px rgba(255,215,0,0.8)',
  },
  seatGrid: {
    display: 'flex',
    flexDirection: 'column' as const,
    gap: '12px',
    alignItems: 'center',
  },
  seatRow: {
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
  },
  rowLabel: {
    width: '30px',
    textAlign: 'center' as const,
    color: '#00ff41',
    fontWeight: 'bold' as const,
    fontSize: '14px',
  },
  seats: {
    display: 'flex',
    gap: '8px',
  },
  seat: {
    width: '60px',
    height: '60px',
    border: '2px solid rgba(0,255,65,0.5)',
    borderRadius: '12px',
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    justifyContent: 'center',
    position: 'relative' as const,
    cursor: 'pointer',
    transition: 'all 0.3s ease',
    background: 'linear-gradient(145deg, rgba(0,0,0,0.7), rgba(30,30,30,0.9))',
  },
  seatAvailable: {
    borderColor: 'rgba(0,255,65,0.5)',
    background: 'linear-gradient(145deg, rgba(0,255,65,0.1), rgba(0,200,50,0.2))',
    boxShadow: '0 4px 15px rgba(0,255,65,0.3)',
  },
  seatOccupied: {
    borderColor: 'rgba(0,128,255,0.7)',
    background: 'linear-gradient(145deg, rgba(0,128,255,0.2), rgba(0,100,200,0.3))',
    boxShadow: '0 4px 15px rgba(0,128,255,0.4)',
  },
  seatReserved: {
    borderColor: 'rgba(255,165,0,0.7)',
    background: 'linear-gradient(145deg, rgba(255,165,0,0.2), rgba(255,140,0,0.3))',
    boxShadow: '0 4px 15px rgba(255,165,0,0.4)',
  },
  seatUnavailable: {
    borderColor: 'rgba(255,0,0,0.5)',
    background: 'linear-gradient(145deg, rgba(255,0,0,0.1), rgba(200,0,0,0.2))',
    cursor: 'not-allowed',
  },
  seatNumber: {
    fontSize: '10px',
    color: '#ffffff',
    fontWeight: 'bold' as const,
  },
  confirmedBadge: {
    position: 'absolute' as const,
    top: '-5px',
    right: '-5px',
    backgroundColor: '#00ff41',
    borderRadius: '50%',
    width: '20px',
    height: '20px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: '10px',
    color: '#000000',
  },
  loading: {
    display: 'flex',
    flexDirection: 'column' as const,
    alignItems: 'center',
    justifyContent: 'center',
    height: '400px',
    background: 'linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #0f0f23 100%)',
    color: '#00ff41',
  },
};

// Âçï‰∏™Â∫ß‰ΩçÁªÑ‰ª∂
const Seat: React.FC<SeatComponentProps> = ({ seat, onClick, readonly }) => {
  const getStatusIcon = (status: SeatStatus) => {
    switch (status) {
      case SeatStatus.OCCUPIED:
        return <CheckCircleOutlined style={{ color: '#0080ff', fontSize: '12px' }} />;
      case SeatStatus.RESERVED:
        return <QuestionCircleOutlined style={{ color: '#ffa500', fontSize: '12px' }} />;
      case SeatStatus.UNAVAILABLE:
        return <CloseCircleOutlined style={{ color: '#ff0000', fontSize: '12px' }} />;
      default:
        return null;
    }
  };

  const getSeatStyle = (status: SeatStatus) => {
    switch (status) {
      case SeatStatus.AVAILABLE:
        return { ...cyberStyles.seat, ...cyberStyles.seatAvailable };
      case SeatStatus.OCCUPIED:
        return { ...cyberStyles.seat, ...cyberStyles.seatOccupied };
      case SeatStatus.RESERVED:
        return { ...cyberStyles.seat, ...cyberStyles.seatReserved };
      case SeatStatus.UNAVAILABLE:
        return { ...cyberStyles.seat, ...cyberStyles.seatUnavailable };
      default:
        return cyberStyles.seat;
    }
  };

  return (
    <Tooltip
      title={
        seat.student ? (
          <div style={{ color: '#ffffff' }}>
            <div>{seat.student.firstName} {seat.student.lastName}</div>
            <div>Â≠¶Âè∑: {seat.student.studentId}</div>
            <div>Â∫ß‰Ωç: {seat.seatId}</div>
            <div>Áä∂ÊÄÅ: {seat.status === SeatStatus.OCCUPIED ? 'Â∑≤Á≠æÂà∞' : 'Â∑≤ÈÄâÂ∫ß'}</div>
            {seat.attendanceConfirmed && <div>Â∑≤Á°ÆËÆ§Á≠æÂà∞</div>}
          </div>
        ) : (
          <div style={{ color: '#ffffff' }}>
            <div>Â∫ß‰Ωç: {seat.seatId}</div>
            <div>Áä∂ÊÄÅ: {
              seat.status === SeatStatus.AVAILABLE ? 'Á©∫Èó≤' :
              seat.status === SeatStatus.RESERVED ? 'È¢ÑÁïô' :
              seat.status === SeatStatus.UNAVAILABLE ? '‰∏çÂèØÁî®' : 'Êú™Áü•'
            }</div>
          </div>
        )
      }
    >
      <div
        style={getSeatStyle(seat.status)}
        onClick={!readonly && seat.status !== SeatStatus.UNAVAILABLE ? onClick : undefined}
      >
        <div style={cyberStyles.seatNumber}>{seat.seatId}</div>
        <div>
          {seat.student ? (
            <Avatar
              size={20}
              src={seat.student.avatar}
              style={{ backgroundColor: '#00ff41', color: '#000000' }}
            >
              {seat.student.firstName[0]}
            </Avatar>
          ) : (
            getStatusIcon(seat.status)
          )}
        </div>
        
        {/* Á≠æÂà∞Á°ÆËÆ§Ê†áËØÜ */}
        {seat.attendanceConfirmed && (
          <div style={cyberStyles.confirmedBadge}>
            <CheckCircleOutlined />
          </div>
        )}
      </div>
    </Tooltip>
  );
};

const SeatMap: React.FC<SeatMapProps> = ({ 
  classroomId, 
  courseId, 
  sessionDate, 
  timeSlot,
  readonly = false,
  onSeatSelect 
}) => {
  const [seatMapData, setSeatMapData] = useState<SeatMapData | null>(null);
  const [loading, setLoading] = useState(true);
  const [selectedSeat, setSelectedSeat] = useState<SeatMapType | null>(null);
  const [studentModalVisible, setStudentModalVisible] = useState(false);
  const [fullscreen, setFullscreen] = useState(false);
  const [availableStudents, setAvailableStudents] = useState<any[]>([]);
  const [selectedStudent, setSelectedStudent] = useState<string>('');
  const [loadingStudents, setLoadingStudents] = useState(false);
  const [checkInLoading, setCheckInLoading] = useState(false);
  const [activeCheckIn, setActiveCheckIn] = useState<CheckInSession | null>(null);
  const { socket, addEventListener } = useSocket();

  // Âä†ËΩΩÂ∫ß‰ΩçÂõæÊï∞ÊçÆ - ‰ΩøÁî®ÂÆûÈôÖAPIÊï∞ÊçÆÔºåÂ§±Ë¥•Êó∂‰ΩøÁî®mockÊï∞ÊçÆ
  const loadSeatMapData = useCallback(async () => {
    try {
      setLoading(true);
      
      // üöÄ È¶ñÂÖàÂ∞ùËØï‰ªéAPIÂä†ËΩΩÂÆûÈôÖÊï∞ÊçÆ
      try {
        const response = await request.get<SeatMapData>(`/classrooms/${classroomId}/seat-map`, {
          params: {
            courseId,
            sessionDate,
            timeSlot: timeSlot || '1'
          }
        });
        
        setSeatMapData(response);
        message.success('üöÄ CYBER PUNK 3DÂ∫ß‰ΩçÂõæÂ∑≤Âä†ËΩΩ - ÂÆûÈôÖÊï∞ÊçÆÔºÅ');
        return;
        
      } catch (apiError) {
        console.warn('APIÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÊºîÁ§∫Êï∞ÊçÆ:', apiError);
      }
      
      // üé≠ APIÂ§±Ë¥•Êó∂‰ΩøÁî®ÁÇ´ÈÖ∑ÁöÑÊºîÁ§∫Êï∞ÊçÆ‰Ωú‰∏∫Â§áÁî®
      const mockClassroom = {
        id: classroomId,
        name: 'üåü ÈáèÂ≠êÊïôÂ≠¶‰∏≠ÂøÉ A101',
        location: 'Êô∫ÊÖßÊïôÂ≠¶Ê•º Êú™Êù•Â±Ç',
        type: 'smart_classroom' as any,
        capacity: 56,
        rows: 8,
        seatsPerRow: 7,
        seatMapEnabled: true,
        freeSeatingEnabled: false,
        layoutConfig: {
          aisles: [2, 5],
          unavailableSeats: ['A1', 'H7']
        },
        createdAt: new Date(),
        updatedAt: new Date()
      };

      const mockSeats: any[] = [];
      const studentNames = [
        'Âº†Êô®Êòü', 'ÊùéÊ¢¶Áë∂', 'ÁéãÂøóËøú', 'ÈôàÊÄùÁê™', 'ÂàòÊµ©ÁÑ∂', 'ËµµÈõ®Ëê±', 
        'Â≠ôÂ≠êËΩ©', 'Âë®ËØ≠Â´£', 'Âê¥Â§©ÂÆá', 'ÈÉëÈõÖÁê™', 'ÈªÑ‰øäÊù∞', 'ÂæêËØóÊ∂µ',
        'Êú±ÊòéËΩ©', 'ÊûóÂøÉÊÄ°', '‰ΩïÊåØÂÆá', 'Ë∞¢ËØ≠Ê°ê', 'ÁΩó‰øäË±™', 'È´òÈõ®Ê∂µ'
      ];
      
      for (let row = 0; row < mockClassroom.rows; row++) {
        for (let col = 0; col < mockClassroom.seatsPerRow; col++) {
          const seatId = String.fromCharCode(65 + row) + (col + 1);
          const isOccupied = Math.random() > 0.4; // 60% Âç†Áî®Áéá
          
          if (!mockClassroom.layoutConfig.unavailableSeats.includes(seatId)) {
            const student = isOccupied ? {
              id: `student_${row}_${col}`,
              firstName: studentNames[Math.floor(Math.random() * studentNames.length)].charAt(0),
              lastName: studentNames[Math.floor(Math.random() * studentNames.length)].slice(1),
              studentId: `202${Math.floor(Math.random() * 10)}${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
              avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${seatId}`,
              major: ['ËÆ°ÁÆóÊú∫ÁßëÂ≠¶', 'ËΩØ‰ª∂Â∑•Á®ã', '‰∫∫Â∑•Êô∫ËÉΩ', 'Êï∞ÊçÆÁßëÂ≠¶'][Math.floor(Math.random() * 4)],
              grade: ['Â§ß‰∏Ä', 'Â§ß‰∫å', 'Â§ß‰∏â', 'Â§ßÂõõ'][Math.floor(Math.random() * 4)]
            } : null;

            mockSeats.push({
              id: `${classroomId}-${seatId}`,
              classroomId: classroomId,
              seatId,
              sessionDate: new Date(sessionDate),
              status: isOccupied ? 'OCCUPIED' : 'AVAILABLE',
              student,
              studentId: student?.id,
              attendanceConfirmed: isOccupied ? Math.random() > 0.3 : false
            });
          }
        }
      }

      const mockSeatMapData: any = {
        classroom: mockClassroom,
        seats: mockSeats,
        attendanceSession: {
          courseId: courseId,
          sessionDate: sessionDate,
          timeSlot: timeSlot || '1'
        }
      };

      setSeatMapData(mockSeatMapData);
      message.success('üöÄ CYBER PUNK 3DÂ∫ß‰ΩçÂõæÂ∑≤Âä†ËΩΩ - ÊºîÁ§∫Ê®°ÂºèÔºÅ');
      
    } catch (error) {
      console.error('Â∫ß‰ΩçÂõæÂä†ËΩΩÂ§±Ë¥•:', error);
      message.error('üö´ Â∫ß‰ΩçÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï');
    } finally {
      setLoading(false);
    }
  }, [classroomId, courseId, sessionDate, timeSlot]);

  // Âä†ËΩΩÂΩìÂâçÊ¥ªË∑ÉÁöÑÁ≠æÂà∞‰ºöËØù
  const loadActiveCheckIn = useCallback(async () => {
    if (!courseId) return;
    
    try {
      console.log('üîç Ê£ÄÊü•Ê¥ªË∑ÉÁöÑÁ≠æÂà∞‰ºöËØù...', courseId);
      const session = await attendanceService.getTodayActiveSession(courseId);
      
      if (session) {
        console.log('‚úÖ ÊâæÂà∞Ê¥ªË∑É‰ºöËØù:', session);
        
        // Ê£ÄÊü•Á≠æÂà∞ÊñπÂºèÊòØÂê¶‰∏∫Â∫ß‰ΩçÈÄâÊã©
        if (session.checkInMethod === CheckInMethod.SEAT_MAP) {
          setActiveCheckIn(session);
          
          // ÁªôÁî®Êà∑ÂèãÂ•ΩÁöÑÊèêÁ§∫
          message.success({
            content: `‚ú® Ê£ÄÊµãÂà∞ËøõË°å‰∏≠ÁöÑÂ∫ß‰ΩçÁ≠æÂà∞‰ºöËØùÔºåÂ∑≤Ëá™Âä®ÊÅ¢Â§çÁä∂ÊÄÅÔºÅ`,
            duration: 4,
            key: 'session-recovery'
          });
          
          console.log('üîÑ Â∫ß‰ΩçÁ≠æÂà∞‰ºöËØùÁä∂ÊÄÅÂ∑≤ÊÅ¢Â§ç:', {
            sessionId: session.id,
            status: session.status,
            checkInMethod: session.checkInMethod,
            startTime: session.startTime || 'N/A',
            totalStudents: session.totalStudents || 0,
            checkedInStudents: session.checkedInStudents || 0
          });
        } else {
          console.log('‚ö†Ô∏è ÊâæÂà∞Ê¥ªË∑É‰ºöËØù‰ΩÜÈùûÂ∫ß‰ΩçÁ≠æÂà∞ÊñπÂºè:', session.checkInMethod);
          setActiveCheckIn(null);
        }
      } else {
        console.log('‚ÑπÔ∏è ‰ªäÊó•ÊöÇÊó†Ê¥ªË∑ÉÁöÑÂ∫ß‰ΩçÁ≠æÂà∞‰ºöËØù');
        setActiveCheckIn(null);
      }
    } catch (error: any) {
      console.error('‚ùå Âä†ËΩΩÊ¥ªË∑É‰ºöËØùÂ§±Ë¥•:', error);
      
      // Â¶ÇÊûúÊòØÁΩëÁªúÈîôËØØÊàñÂÖ∂‰ªñËøûÊé•ÈóÆÈ¢òÔºåÁªôÂá∫Êõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ
      if (error.code === 'NETWORK_ERROR' || error.message?.includes('fetch')) {
        console.warn('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåÊó†Ê≥ïÊÅ¢Â§çÁ≠æÂà∞‰ºöËØùÁä∂ÊÄÅ');
      } else if (error.response?.status === 404) {
        // 404ÊòØÊ≠£Â∏∏ÊÉÖÂÜµÔºåËØ¥Êòé‰ªäÊó•ÊöÇÊó†Ê¥ªË∑É‰ºöËØù
        console.log('‚úÖ Á°ÆËÆ§‰ªäÊó•ÊöÇÊó†Ê¥ªË∑ÉÁ≠æÂà∞‰ºöËØù');
      } else {
        message.warning('Êó†Ê≥ïÊ£ÄÊü•Ê¥ªË∑ÉÁ≠æÂà∞‰ºöËØùÁä∂ÊÄÅÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢');
      }
      
      setActiveCheckIn(null);
    }
  }, [courseId]);

  useEffect(() => {
    // È°µÈù¢Âä†ËΩΩÊó∂ÁöÑÂàùÂßãÂåñÂ∫èÂàó
    const initialize = async () => {
      try {
        // ÂÖàÂä†ËΩΩÊ¥ªË∑ÉÁöÑÁ≠æÂà∞‰ºöËØù
        await loadActiveCheckIn();
        // ÂÜçÂä†ËΩΩÂ∫ß‰ΩçÂõæÊï∞ÊçÆ
        await loadSeatMapData();
      } catch (error) {
        console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
      }
    };

    initialize();
  }, [courseId]); // ÁÆÄÂåñ‰æùËµñÔºå‰ªÖ‰æùËµñ courseId

  // Âä†ÂÖ•WebSocketÊàøÈó¥Âπ∂ÁõëÂê¨ÂÆûÊó∂Â∫ß‰ΩçÂõæÊõ¥Êñ∞
  useEffect(() => {
    if (!socket || !classroomId || !sessionDate) return;

    console.log('üè† Joining classroom WebSocket room:', { classroomId, sessionDate, timeSlot });
    
    // Âä†ÂÖ•ÊïôÂÆ§WebSocketÊàøÈó¥
    socket.emit('join_classroom', {
      classroomId,
      sessionDate,
      timeSlot: timeSlot || 'default'
    });

    // ÁõëÂê¨Â∫ß‰ΩçÂõæÊõ¥Êñ∞‰∫ã‰ª∂
    const cleanup1 = addEventListener('seat_map_update', (data) => {
      console.log('üì° Received seat_map_update:', data);
      
      if (data.classroomId === classroomId && data.sessionDate === sessionDate) {
        setSeatMapData((prevData) => {
          if (!prevData) return prevData;
          
          const updatedSeats = prevData.seats.map((seat) => {
            if (seat.seatId === data.seatId) {
              console.log('üîÑ Updating seat:', data.seatId, 'from status:', seat.status, 'to status:', data.status);
              return { 
                ...seat, 
                status: data.status,
                studentId: data.studentId,
                attendanceConfirmed: data.attendanceConfirmed 
              };
            }
            return seat;
          });
          
          const newData = {
            ...prevData,
            seats: updatedSeats,
          };
          
          // Âº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆóÁªüËÆ°‰ø°ÊÅØ
          setTimeout(() => {
            const stats = {
              total: updatedSeats.length,
              occupied: updatedSeats.filter((s: any) => s.status === SeatStatus.OCCUPIED).length,
              available: updatedSeats.filter((s: any) => s.status === SeatStatus.AVAILABLE).length,
              confirmed: updatedSeats.filter((s: any) => s.attendanceConfirmed).length,
            };
            console.log('üìä Updated seat statistics:', stats);
          }, 100);
          
          return newData;
        });
        
        // Â¶ÇÊûúÊòØÂ≠¶ÁîüÁ≠æÂà∞ÔºåÊòæÁ§∫ÈÄöÁü•
        if (data.status === 'occupied' && data.studentId) {
          message.success({
            content: `Â≠¶Áîü ${data.studentId} Â∑≤ÈÄâÊã©Â∫ß‰Ωç ${data.seatId}`,
            duration: 3,
            key: `seat-occupied-${data.seatId}`
          });
        }
      }
    });

    // ÁõëÂê¨ËÄÉÂã§Á°ÆËÆ§‰∫ã‰ª∂
    const cleanup2 = addEventListener('attendance_confirmed', (data) => {
      console.log('‚úÖ Attendance confirmed:', data);
      message.success({
        content: `Â≠¶Áîü ${data.studentId} Âú®Â∫ß‰Ωç ${data.seatId} Á≠æÂà∞ÊàêÂäü`,
        duration: 4,
        key: `attendance-confirmed-${data.seatId}`
      });
    });

    // Á¶ªÂºÄÊàøÈó¥ÁöÑÊ∏ÖÁêÜÂáΩÊï∞
    return () => {
      console.log('üèÉ Leaving classroom WebSocket room');
      socket.emit('leave_classroom', {
        classroomId,
        sessionDate,
        timeSlot: timeSlot || 'default'
      });
      cleanup1();
      cleanup2();
    };
  }, [socket, classroomId, sessionDate, timeSlot, addEventListener]);

  // Â§ÑÁêÜÂ∫ß‰ΩçÁÇπÂáª
  const handleSeatClick = (seat: SeatMapType) => {
    if (readonly) return;
    
    setSelectedSeat(seat);
    
    if (seat.status === SeatStatus.AVAILABLE) {
      setStudentModalVisible(true);
    } else if (seat.status === SeatStatus.OCCUPIED || seat.status === SeatStatus.RESERVED) {
      onSeatSelect?.(seat.seatId, seat.studentId);
    }
  };

  // Âä†ËΩΩÂèØÁî®Â≠¶ÁîüÂàóË°®
  const loadAvailableStudents = useCallback(async () => {
    try {
      setLoadingStudents(true);
      const response = await request.get(`/courses/${courseId}/students/available`, {
        params: {
          sessionDate,
          timeSlot: timeSlot || '1'
        }
      });
      setAvailableStudents(response);
    } catch (error) {
      console.warn('Âä†ËΩΩÂ≠¶ÁîüÂàóË°®Â§±Ë¥•Ôºå‰ΩøÁî®mockÊï∞ÊçÆ:', error);
      // ‰ΩøÁî®mockÂ≠¶ÁîüÊï∞ÊçÆ
      const mockStudents = [
        { id: '1', firstName: 'Âº†', lastName: 'Êô®Êòü', studentId: '20231001' },
        { id: '2', firstName: 'Êùé', lastName: 'Ê¢¶Áë∂', studentId: '20231002' },
        { id: '3', firstName: 'Áéã', lastName: 'ÂøóËøú', studentId: '20231003' },
        { id: '4', firstName: 'Èôà', lastName: 'ÊÄùÁê™', studentId: '20231004' },
        { id: '5', firstName: 'Âàò', lastName: 'Êµ©ÁÑ∂', studentId: '20231005' },
      ];
      setAvailableStudents(mockStudents);
    } finally {
      setLoadingStudents(false);
    }
  }, [courseId, sessionDate, timeSlot]);

  // ÂàÜÈÖçÂ≠¶ÁîüÂà∞Â∫ß‰Ωç
  const handleAssignStudent = async (studentId: string, seatId: string) => {
    try {
      await request.post(`/classrooms/${classroomId}/assign-seat`, {
        courseId,
        sessionDate,
        timeSlot: timeSlot || '1',
        seatId,
        studentId
      });
      
      message.success(`üöÄ Â≠¶ÁîüÂ∑≤ÊàêÂäüÂàÜÈÖçÂà∞Â∫ß‰Ωç ${seatId}`);
      setStudentModalVisible(false);
      setSelectedStudent('');
      loadSeatMapData(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      
    } catch (error: any) {
      console.error('ÂàÜÈÖçÂ∫ß‰ΩçÂ§±Ë¥•:', error);
      message.error(error.message || 'ÂàÜÈÖçÂ∫ß‰ΩçÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  };

  // Âà∑Êñ∞Â∫ß‰ΩçÂõæ
  const handleRefresh = () => {
    loadSeatMapData();
    loadActiveCheckIn();
    message.success('üöÄ Â∫ß‰ΩçÂõæÊï∞ÊçÆÂ∑≤Âà∑Êñ∞');
  };

  // ÂºÄÂßãÂ∫ß‰ΩçÁ≠æÂà∞
  const handleStartCheckIn = async () => {
    try {
      setCheckInLoading(true);
      
      console.log('üöÄ ÂáÜÂ§áÂêØÂä®Â∫ß‰ΩçÁ≠æÂà∞:', { 
        courseId, 
        checkInMethod: CheckInMethod.SEAT_MAP,
        baseURL: process.env.REACT_APP_API_URL || 'http://localhost:3000/api'
      });

      // üîç ËØ¶ÁªÜÈîôËØØÊçïËé∑
      const session = await attendanceService.startCheckIn({
        courseId,
        checkInMethod: CheckInMethod.SEAT_MAP,
        duration: 30
      });
      
      console.log('‚úÖ Â∫ß‰ΩçÁ≠æÂà∞ÂêØÂä®ÊàêÂäü:', session);
      setActiveCheckIn(session);
      message.success('ü™ë Â∫ß‰ΩçÁ≠æÂà∞Â∑≤ÂºÄÂßãÔºåÂ≠¶ÁîüÂèØ‰ª•ÂºÄÂßãÈÄâÂ∫ßÁ≠æÂà∞');
      
      // ÈáçÊñ∞Âä†ËΩΩÂ∫ß‰ΩçÂõæÊï∞ÊçÆ‰ª•ÊòæÁ§∫ÊúÄÊñ∞Áä∂ÊÄÅ
      loadSeatMapData();
      
    } catch (error: any) {
      console.error('üö´ Â∫ß‰ΩçÁ≠æÂà∞ÂêØÂä®Â§±Ë¥• - ËØ¶ÁªÜ‰ø°ÊÅØ:', {
        message: error.message,
        response: error.response,
        request: error.request,
        config: error.config,
        stack: error.stack,
        name: error.name,
        code: error.code,
        errno: error.errno
      });
      
      // ÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
      if (error.response) {
        const errorMessage = error.response.data?.message || error.message;
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ≠æÂà∞‰ºöËØùÂ∑≤Â≠òÂú®ÁöÑÈîôËØØ
        if (errorMessage.includes('Á≠æÂà∞‰ºöËØùÂ∑≤ÁªèÂ≠òÂú®') || errorMessage.includes('already exists') || errorMessage.includes('Active session')) {
          message.warning('Á≠æÂà∞‰ºöËØùÂ∑≤Âú®ËøõË°å‰∏≠');
          // ÈáçÊñ∞Âä†ËΩΩÊ¥ªË∑ÉÁ≠æÂà∞Áä∂ÊÄÅ
          loadActiveCheckIn();
        } else {
          message.error(`ÊúçÂä°Âô®ÈîôËØØ: ${error.response.status} - ${errorMessage}`);
        }
      } else if (error.request) {
        message.error(`ÁΩëÁªúËøûÊé•ÈîôËØØ: ${error.message} - ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåÂêéÁ´ØÊúçÂä°`);
      } else {
        message.error(`ËØ∑Ê±ÇÈÖçÁΩÆÈîôËØØ: ${error.message}`);
      }
    } finally {
      setCheckInLoading(false);
    }
  };

  // ÁªìÊùüÂ∫ß‰ΩçÁ≠æÂà∞
  const handleEndCheckIn = async () => {
    if (!activeCheckIn) return;
    
    try {
      setCheckInLoading(true);
      await attendanceService.endCheckIn(activeCheckIn.id);
      setActiveCheckIn(null);
      message.success('Â∫ß‰ΩçÁ≠æÂà∞Â∑≤ÁªìÊùü');
    } catch (error) {
      // ÈîôËØØÂ∑≤Âú®service‰∏≠Â§ÑÁêÜ
    } finally {
      setCheckInLoading(false);
    }
  };

  // ÁîüÊàêÂ∫ß‰ΩçÁΩëÊ†º
  const renderSeatGrid = () => {
    if (!seatMapData) return null;
    
    const { classroom, seats } = seatMapData;
    const seatGrid: Array<Array<SeatMapType | null>> = [];
    
    // ÂàõÂª∫‰∫åÁª¥Êï∞ÁªÑË°®Á§∫Â∫ß‰ΩçÁΩëÊ†º
    for (let row = 0; row < classroom.rows; row++) {
      seatGrid[row] = [];
      for (let col = 0; col < classroom.seatsPerRow; col++) {
        const seatId = String.fromCharCode(65 + row) + (col + 1);
        const seat = seats.find((s: any) => s.seatId === seatId);
        
        if (seat) {
          seatGrid[row][col] = seat;
        } else {
          seatGrid[row][col] = {
            id: `${classroomId}-${seatId}`,
            classroomId,
            seatId,
            sessionDate: new Date(sessionDate),
            status: classroom.layoutConfig?.unavailableSeats?.includes(seatId) 
              ? SeatStatus.UNAVAILABLE 
              : SeatStatus.AVAILABLE,
            attendanceConfirmed: false,
          };
        }
      }
    }
    
    return seatGrid.map((row, rowIndex) => (
      <div key={rowIndex} style={cyberStyles.seatRow}>
        <div style={cyberStyles.rowLabel}>
          {String.fromCharCode(65 + rowIndex)}
        </div>
        <div style={cyberStyles.seats}>
          {row.map((seat, colIndex) => {
            const isAisle = classroom.layoutConfig?.aisles?.includes(colIndex);
            
            return (
              <React.Fragment key={colIndex}>
                {seat && (
                  <Seat
                    seat={seat}
                    onClick={() => handleSeatClick(seat)}
                    readonly={readonly}
                  />
                )}
                {isAisle && <div style={{ width: '20px' }} />}
              </React.Fragment>
            );
          })}
        </div>
      </div>
    ));
  };

  // ‰ΩøÁî® useMemo Á°Æ‰øùÁªüËÆ°‰ø°ÊÅØÂÆûÊó∂Êõ¥Êñ∞
  const stats = useMemo(() => {
    if (!seatMapData) return { total: 0, occupied: 0, available: 0, confirmed: 0 };
    
    const { seats } = seatMapData;
    const total = seats.length;
    const occupied = seats.filter((s: any) => s.status === SeatStatus.OCCUPIED).length;
    const available = seats.filter((s: any) => s.status === SeatStatus.AVAILABLE).length;
    const confirmed = seats.filter((s: any) => s.attendanceConfirmed).length;
    
    console.log('üìä Real-time stats calculation:', { total, occupied, available, confirmed });
    
    return { total, occupied, available, confirmed };
  }, [seatMapData]);

  if (loading) {
    return (
      <div style={cyberStyles.loading}>
        <div style={{ fontSize: '24px', marginBottom: '16px' }}>üöÄ</div>
        <div style={{ fontSize: '18px' }}>Âä†ËΩΩ CYBER PUNK 3DÂ∫ß‰ΩçÂõæ‰∏≠...</div>
      </div>
    );
  }

  if (!seatMapData) {
    return (
      <div style={cyberStyles.container}>
        <div style={{ textAlign: 'center', padding: '100px 0', color: '#ff0000' }}>
          <div style={{ fontSize: '18px' }}>Êó†Ê≥ïÂä†ËΩΩÂ∫ß‰ΩçÂõæÊï∞ÊçÆ</div>
        </div>
      </div>
    );
  }

  return (
    <div style={fullscreen ? { ...cyberStyles.container, position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 9999 } : cyberStyles.container}>
      {/* ÂÖ®ÊÅØÁªüËÆ°Èù¢Êùø */}
      <div style={cyberStyles.dashboard}>
        <div style={cyberStyles.dashboardHeader}>
          <div style={cyberStyles.dashboardTitle}>üåü {seatMapData.classroom.name}</div>
          <div style={cyberStyles.dashboardSubtitle}>üöÄ CYBER PUNK 3DÂ∫ß‰ΩçÂõæ v2.0.1 - Â∑≤ÊøÄÊ¥ªÔºÅ</div>
        </div>
        
        <div style={cyberStyles.statsGrid}>
          <div style={cyberStyles.statCard}>
            <div style={cyberStyles.statNumber}>{stats.occupied}</div>
            <div style={cyberStyles.statLabel}>Â∑≤Á≠æÂà∞</div>
          </div>
          
          <div style={cyberStyles.statCard}>
            <div style={cyberStyles.statNumber}>{stats.confirmed}</div>
            <div style={cyberStyles.statLabel}>Â∑≤Á°ÆËÆ§</div>
          </div>
          
          <div style={cyberStyles.statCard}>
            <div style={cyberStyles.statNumber}>{stats.available}</div>
            <div style={cyberStyles.statLabel}>Á©∫Èó≤Â∏≠‰Ωç</div>
          </div>
          
          <div style={cyberStyles.statCard}>
            <div style={cyberStyles.statNumber}>{stats.total}</div>
            <div style={cyberStyles.statLabel}>ÊÄªÂ∏≠‰Ωç</div>
          </div>
        </div>
      </div>

      {/* ÊéßÂà∂ÊåâÈíÆÁªÑ */}
      <div style={cyberStyles.controlPanel}>
        <Button 
          style={cyberStyles.cyberButton}
          icon={<ReloadOutlined />} 
          onClick={handleRefresh}
        >
          Âà∑Êñ∞Êï∞ÊçÆ
        </Button>
        <Button
          style={cyberStyles.cyberButton}
          icon={<FullscreenOutlined />}
          onClick={() => setFullscreen(!fullscreen)}
        >
          {fullscreen ? 'ÈÄÄÂá∫ÂÖ®Â±è' : 'ÂÖ®Â±èÊ®°Âºè'}
        </Button>
        {!readonly && (
          <>
            <Button 
              style={{
                ...cyberStyles.cyberButton,
                background: activeCheckIn 
                  ? 'linear-gradient(145deg, rgba(255,0,0,0.2), rgba(255,100,100,0.2))'
                  : 'linear-gradient(145deg, rgba(0,255,65,0.2), rgba(0,128,255,0.2))',
                borderColor: activeCheckIn ? 'rgba(255,0,0,0.5)' : 'rgba(0,255,65,0.5)',
                color: activeCheckIn ? '#ff4d4f' : '#00ff41'
              }}
              icon={activeCheckIn ? <StopOutlined /> : <PlayCircleOutlined />}
              loading={checkInLoading}
              onClick={activeCheckIn ? handleEndCheckIn : handleStartCheckIn}
            >
              {checkInLoading ? 'Â§ÑÁêÜ‰∏≠...' : (activeCheckIn ? 'üõë ÁªìÊùüÁ≠æÂà∞ÔºàËøõË°å‰∏≠Ôºâ' : 'ü™ë ÂºÄÂßãÂ∫ß‰ΩçÁ≠æÂà∞')}
            </Button>
            <Button 
              style={cyberStyles.cyberButton}
              icon={<SettingOutlined />} 
              onClick={() => {}}
            >
              Á≥ªÁªüËÆæÁΩÆ
            </Button>
          </>
        )}
      </div>

      {/* 3DÂ∫ß‰ΩçÁΩëÊ†º */}
      <div>
        {/* ËÆ≤Âè∞ */}
        <div style={cyberStyles.podium}>
          üéØ Êô∫ËÉΩËÆ≤Âè∞ - CYBER PUNK MODE
        </div>
        
        {/* Â∫ß‰ΩçÁΩëÊ†º */}
        <div style={cyberStyles.seatGrid}>
          {renderSeatGrid()}
        </div>
      </div>

      {/* Â≠¶ÁîüÈÄâÊã©Ê®°ÊÄÅÊ°Ü */}
      <Modal
        title={
          <div style={{ color: '#00ff41', textShadow: '0 0 10px rgba(0,255,65,0.6)' }}>
            üîÆ ‰∏∫Â∫ß‰Ωç {selectedSeat?.seatId} ÂàÜÈÖçÂ≠¶Áîü
          </div>
        }
        open={studentModalVisible}
        onCancel={() => {
          setStudentModalVisible(false);
          setSelectedStudent('');
        }}
        footer={[
          <Button 
            key="cancel" 
            style={{ 
              background: 'rgba(255,0,0,0.2)', 
              border: '1px solid rgba(255,0,0,0.5)',
              color: '#ff4d4f'
            }}
            onClick={() => {
              setStudentModalVisible(false);
              setSelectedStudent('');
            }}
          >
            ÂèñÊ∂à
          </Button>,
          <Button 
            key="submit" 
            style={{
              background: 'linear-gradient(145deg, rgba(0,255,65,0.2), rgba(0,128,255,0.2))',
              border: '2px solid rgba(0,255,65,0.5)',
              color: '#00ff41'
            }}
            disabled={!selectedStudent}
            onClick={() => selectedSeat && handleAssignStudent(selectedStudent, selectedSeat.seatId)}
          >
            üöÄ Á°ÆËÆ§ÂàÜÈÖç
          </Button>
        ]}
        width={500}
        style={{ 
          background: 'rgba(0,0,0,0.8)',
        }}
        bodyStyle={{ 
          background: 'linear-gradient(145deg, rgba(0,0,0,0.9), rgba(30,30,30,0.95))',
          color: '#ffffff'
        }}
      >
        <div style={{ padding: '16px 0' }}>
          <div style={{ marginBottom: '16px', color: '#0080ff', fontSize: '14px' }}>
            üìç ÈÄâÊã©Ë¶ÅÂàÜÈÖçÂà∞Â∫ß‰Ωç <span style={{ color: '#00ff41', fontWeight: 'bold' }}>{selectedSeat?.seatId}</span> ÁöÑÂ≠¶ÁîüÔºö
          </div>
          
          <Select
            style={{ width: '100%' }}
            placeholder="üîç ÊêúÁ¥¢Âπ∂ÈÄâÊã©Â≠¶Áîü"
            value={selectedStudent}
            onChange={setSelectedStudent}
            loading={loadingStudents}
            showSearch
            filterOption={(input, option) =>
              option?.label?.toLowerCase().includes(input.toLowerCase()) ?? false
            }
            options={availableStudents.map(student => ({
              value: student.id,
              label: `${student.firstName}${student.lastName} (${student.studentId})`,
            }))}
            onDropdownVisibleChange={(open) => {
              if (open && availableStudents.length === 0) {
                loadAvailableStudents();
              }
            }}
            dropdownStyle={{
              background: 'rgba(0,0,0,0.95)',
              border: '1px solid rgba(0,255,65,0.3)'
            }}
          />
          
          {selectedStudent && (
            <div style={{ 
              marginTop: '12px', 
              padding: '8px', 
              background: 'rgba(0,255,65,0.1)', 
              border: '1px solid rgba(0,255,65,0.3)',
              borderRadius: '4px',
              fontSize: '12px',
              color: '#00ff41'
            }}>
              ‚úÖ Â∑≤ÈÄâÊã©Â≠¶ÁîüÔºåÁÇπÂáªÁ°ÆËÆ§ÂàÜÈÖçÊåâÈíÆÂÆåÊàêÊìç‰Ωú
            </div>
          )}
        </div>
      </Modal>
    </div>
  );
};

export default SeatMap;